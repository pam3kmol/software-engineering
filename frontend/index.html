<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address Book</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .contact-card { 
            border-radius: 10px; 
            margin-bottom: 20px; 
            transition: transform 0.3s; 
        }
        .contact-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
        }
        .bookmarked { border: 2px solid #ffc107; }
        .star-btn { color: #ffc107; cursor: pointer; font-size: 1.2rem; }
        .tag { background: #e9ecef; padding: 2px 8px; border-radius: 10px; margin: 2px; display: inline-block; }
        .modal-lg { max-width: 800px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部导航 -->
        <nav class="navbar navbar-dark bg-primary rounded mb-4">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="bi bi-book me-2"></i>Address Book
                </span>
                <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#contactModal">
                    <i class="bi bi-plus"></i> Add Contact
                </button>
            </div>
        </nav>

        <!-- 搜索和筛选 -->
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control" placeholder="Search contacts...">
            </div>
            <div class="col-md-6">
                <div class="btn-group w-100">
                    <button class="btn btn-outline-primary active" onclick="showAll()">All</button>
                    <button class="btn btn-outline-primary" onclick="showBookmarked()">
                        <i class="bi bi-star"></i> Bookmarks
                    </button>
                </div>
            </div>
        </div>

        <!-- 导入导出按钮 -->
        <div class="mb-4">
            <button class="btn btn-success me-2" onclick="exportContacts()">
                <i class="bi bi-file-excel"></i> Export Excel
            </button>
            <button class="btn btn-info me-2" onclick="document.getElementById('fileInput').click()">
                <i class="bi bi-upload"></i> Import
            </button>
            <input type="file" id="fileInput" style="display:none" accept=".json" onchange="importContacts(event)">
            <button class="btn btn-secondary" onclick="downloadTemplate()">
                <i class="bi bi-download"></i> Template
            </button>
        </div>

        <!-- 联系人列表 -->
        <div id="contactsContainer" class="row"></div>
        
        <!-- 空状态 -->
        <div id="emptyState" class="text-center mt-5" style="display:none">
            <i class="bi bi-people display-1 text-muted"></i>
            <h3 class="mt-3">No contacts yet</h3>
            <p>Add your first contact to get started</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#contactModal">
                <i class="bi bi-plus"></i> Add Contact
            </button>
        </div>

        <!-- 联系人模态框 -->
        <div class="modal fade" id="contactModal">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Contact</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="contactForm">
                            <div class="mb-3">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            
                            <!-- 电话号码 -->
                            <div class="mb-3">
                                <label>Phone Numbers</label>
                                <div id="phones">
                                    <div class="input-group mb-2">
                                        <input type="tel" class="form-control" placeholder="Phone">
                                        <select class="form-select" style="width:100px">
                                            <option>Mobile</option>
                                            <option>Home</option>
                                            <option>Work</option>
                                        </select>
                                        <button type="button" class="btn btn-outline-danger" onclick="removePhone(this)">×</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPhone()">
                                    <i class="bi bi-plus"></i> Add Phone
                                </button>
                            </div>
                            
                            <!-- 邮箱地址 -->
                            <div class="mb-3">
                                <label>Email Addresses</label>
                                <div id="emails">
                                    <div class="input-group mb-2">
                                        <input type="email" class="form-control" placeholder="Email">
                                        <select class="form-select" style="width:100px">
                                            <option>Personal</option>
                                            <option>Work</option>
                                        </select>
                                        <button type="button" class="btn btn-outline-danger" onclick="removeEmail(this)">×</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEmail()">
                                    <i class="bi bi-plus"></i> Add Email
                                </button>
                            </div>
                            
                            <!-- 书签 -->
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="bookmark">
                                <label class="form-check-label">
                                    <i class="bi bi-star"></i> Bookmark this contact
                                </label>
                            </div>
                            
                            <!-- 标签 -->
                            <div class="mb-3">
                                <label>Tags</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="tagInput" placeholder="Add tag">
                                    <button type="button" class="btn btn-outline-secondary" onclick="addTag()">Add</button>
                                </div>
                                <div id="tags" class="mt-2"></div>
                            </div>
                            
                            <!-- 备注 -->
                            <div class="mb-3">
                                <label>Notes</label>
                                <textarea class="form-control" id="notes" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveContact()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script>
        // 初始化
        let contacts = JSON.parse(localStorage.getItem('contacts')) || [];
        let editingId = null;
        
        // 页面加载
        document.addEventListener('DOMContentLoaded', function() {
            renderContacts();
            document.getElementById('searchInput').addEventListener('input', searchContacts);
        });
        
        // 渲染联系人
        function renderContacts(list = contacts) {
            const container = document.getElementById('contactsContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (list.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = list.map(contact => `
                <div class="col-md-6 col-lg-4">
                    <div class="card contact-card ${contact.bookmark ? 'bookmarked' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h5>${escapeHtml(contact.name)}</h5>
                                <i class="bi bi-star${contact.bookmark ? '-fill' : ''} star-btn" 
                                   onclick="toggleBookmark('${contact.id}')"></i>
                            </div>
                            
                            ${contact.phones.map(phone => `
                                <div><i class="bi bi-telephone"></i> ${escapeHtml(phone.number)} 
                                <small class="text-muted">(${phone.type})</small></div>
                            `).join('')}
                            
                            ${contact.emails.map(email => `
                                <div><i class="bi bi-envelope"></i> ${escapeHtml(email.address)} 
                                <small class="text-muted">(${email.type})</small></div>
                            `).join('')}
                            
                            ${contact.tags.length > 0 ? `
                                <div class="mt-2">
                                    ${contact.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                                </div>
                            ` : ''}
                            
                            ${contact.notes ? `<p class="mt-2"><small>${escapeHtml(contact.notes)}</small></p>` : ''}
                            
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="editContact('${contact.id}')">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteContact('${contact.id}')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 添加电话号码字段
        function addPhone() {
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="tel" class="form-control" placeholder="Phone">
                <select class="form-select" style="width:100px">
                    <option>Mobile</option>
                    <option>Home</option>
                    <option>Work</option>
                </select>
                <button type="button" class="btn btn-outline-danger" onclick="removePhone(this)">×</button>
            `;
            document.getElementById('phones').appendChild(div);
        }
        
        // 添加邮箱字段
        function addEmail() {
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="email" class="form-control" placeholder="Email">
                <select class="form-select" style="width:100px">
                    <option>Personal</option>
                    <option>Work</option>
                </select>
                <button type="button" class="btn btn-outline-danger" onclick="removeEmail(this)">×</button>
            `;
            document.getElementById('emails').appendChild(div);
        }
        
        // 删除电话号码
        function removePhone(btn) {
            const phones = document.getElementById('phones');
            if (phones.children.length > 1) btn.parentElement.remove();
        }
        
        // 删除邮箱
        function removeEmail(btn) {
            const emails = document.getElementById('emails');
            if (emails.children.length > 1) btn.parentElement.remove();
        }
        
        // 添加标签
        function addTag() {
            const input = document.getElementById('tagInput');
            if (input.value.trim()) {
                const tagDiv = document.getElementById('tags');
                const span = document.createElement('span');
                span.className = 'tag me-1';
                span.innerHTML = `${escapeHtml(input.value)} <i class="bi bi-x" onclick="this.parentElement.remove()"></i>`;
                tagDiv.appendChild(span);
                input.value = '';
            }
        }
        
        // 保存联系人
        function saveContact() {
            const name = document.getElementById('name').value.trim();
            if (!name) return alert('Please enter name');
            
            // 收集电话号码
            const phones = [];
            document.querySelectorAll('#phones .input-group').forEach(group => {
                const input = group.querySelector('input');
                const select = group.querySelector('select');
                if (input.value.trim()) {
                    phones.push({
                        number: input.value.trim(),
                        type: select.value
                    });
                }
            });
            
            // 收集邮箱地址
            const emails = [];
            document.querySelectorAll('#emails .input-group').forEach(group => {
                const input = group.querySelector('input');
                const select = group.querySelector('select');
                if (input.value.trim()) {
                    emails.push({
                        address: input.value.trim(),
                        type: select.value
                    });
                }
            });
            
            // 收集标签
            const tags = [];
            document.querySelectorAll('#tags .tag').forEach(tag => {
                tags.push(tag.textContent.replace('×', '').trim());
            });
            
            // 收集其他信息
            const contact = {
                id: editingId || Date.now().toString(),
                name: name,
                phones: phones,
                emails: emails,
                tags: tags,
                bookmark: document.getElementById('bookmark').checked,
                notes: document.getElementById('notes').value.trim()
            };
            
            // 保存
            if (editingId) {
                const index = contacts.findIndex(c => c.id === editingId);
                contacts[index] = contact;
            } else {
                contacts.push(contact);
            }
            
            localStorage.setItem('contacts', JSON.stringify(contacts));
            renderContacts();
            
            // 关闭模态框并重置
            const modal = bootstrap.Modal.getInstance(document.getElementById('contactModal'));
            modal.hide();
            resetForm();
        }
        
        // 编辑联系人
        function editContact(id) {
            const contact = contacts.find(c => c.id === id);
            if (!contact) return;
            
            editingId = id;
            
            // 填充表单
            document.getElementById('name').value = contact.name;
            document.getElementById('bookmark').checked = contact.bookmark;
            document.getElementById('notes').value = contact.notes || '';
            
            // 填充电话号码
            document.getElementById('phones').innerHTML = '';
            contact.phones.forEach(phone => {
                addPhone();
                const lastInput = document.querySelector('#phones .input-group:last-child input');
                const lastSelect = document.querySelector('#phones .input-group:last-child select');
                if (lastInput) lastInput.value = phone.number;
                if (lastSelect) lastSelect.value = phone.type;
            });
            
            // 填充邮箱地址
            document.getElementById('emails').innerHTML = '';
            contact.emails.forEach(email => {
                addEmail();
                const lastInput = document.querySelector('#emails .input-group:last-child input');
                const lastSelect = document.querySelector('#emails .input-group:last-child select');
                if (lastInput) lastInput.value = email.address;
                if (lastSelect) lastSelect.value = email.type;
            });
            
            // 填充标签
            document.getElementById('tags').innerHTML = '';
            contact.tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = 'tag me-1';
                span.innerHTML = `${escapeHtml(tag)} <i class="bi bi-x" onclick="this.parentElement.remove()"></i>`;
                document.getElementById('tags').appendChild(span);
            });
            
            // 显示模态框
            new bootstrap.Modal(document.getElementById('contactModal')).show();
        }
        
        // 切换书签
        function toggleBookmark(id) {
            const contact = contacts.find(c => c.id === id);
            if (contact) {
                contact.bookmark = !contact.bookmark;
                localStorage.setItem('contacts', JSON.stringify(contacts));
                renderContacts();
            }
        }
        
        // 删除联系人
        function deleteContact(id) {
            if (confirm('Delete this contact?')) {
                contacts = contacts.filter(c => c.id !== id);
                localStorage.setItem('contacts', JSON.stringify(contacts));
                renderContacts();
            }
        }
        
        // 搜索联系人
        function searchContacts() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            if (!term) return renderContacts();
            
            const filtered = contacts.filter(contact =>
                contact.name.toLowerCase().includes(term) ||
                contact.phones.some(p => p.number.includes(term)) ||
                contact.emails.some(e => e.address.toLowerCase().includes(term)) ||
                contact.tags.some(t => t.toLowerCase().includes(term))
            );
            
            renderContacts(filtered);
        }
        
        // 显示所有联系人
        function showAll() {
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderContacts(contacts);
        }
        
        // 显示收藏的联系人
        function showBookmarked() {
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            const bookmarked = contacts.filter(c => c.bookmark);
            renderContacts(bookmarked);
        }
        
        // 导出到Excel
        function exportContacts() {
            const data = contacts.map(c => ({
                Name: c.name,
                Phones: c.phones.map(p => `${p.number} (${p.type})`).join(', '),
                Emails: c.emails.map(e => `${e.address} (${e.type})`).join(', '),
                Tags: c.tags.join(', '),
                Bookmarked: c.bookmark ? 'Yes' : 'No',
                Notes: c.notes
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Contacts");
            XLSX.writeFile(wb, "contacts.xlsx");
        }
        
        // 导入联系人
        function importContacts(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    imported.forEach(c => {
                        if (!c.id) c.id = Date.now().toString() + Math.random();
                        contacts.push(c);
                    });
                    
                    localStorage.setItem('contacts', JSON.stringify(contacts));
                    renderContacts();
                    alert(`Imported ${imported.length} contacts`);
                } catch (err) {
                    alert('Error importing: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // 下载模板
        function downloadTemplate() {
            const template = [
                {
                    id: "1",
                    name: "John Doe",
                    phones: [{ number: "123-456-7890", type: "Mobile" }],
                    emails: [{ address: "john@example.com", type: "Personal" }],
                    tags: ["Friend"],
                    bookmark: true,
                    notes: "Sample contact"
                }
            ];
            
            const data = JSON.stringify(template, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'contacts_template.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // 重置表单
        function resetForm() {
            document.getElementById('contactForm').reset();
            document.getElementById('phones').innerHTML = '';
            document.getElementById('emails').innerHTML = '';
            document.getElementById('tags').innerHTML = '';
            editingId = null;
            addPhone();
            addEmail();
        }
        
        // 转义HTML，防止XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 初始化表单
        addPhone();
        addEmail();
    </script>
</body>
</html>